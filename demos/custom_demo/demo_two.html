<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Villager Service - Sign Up</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(135deg, #fdf2f8 0%, #fce7f3 50%, #f5d0fe 100%);
            min-height: 100vh;
            padding: 40px 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #ec4899 0%, #a855f7 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            box-shadow: 0 10px 40px rgba(168, 85, 247, 0.3);
        }

        .logo svg {
            width: 45px;
            height: 45px;
            fill: white;
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, #be185d 0%, #7c3aed 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        .header p {
            color: #9333ea;
            font-size: 1.1rem;
            font-weight: 400;
        }

        .card {
            background: white;
            border-radius: 24px;
            padding: 32px;
            box-shadow: 0 20px 60px rgba(168, 85, 247, 0.15);
            margin-bottom: 24px;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #581c87;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .card-title .icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #f9a8d4 0%, #c4b5fd 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .card-title .icon svg {
            width: 20px;
            height: 20px;
            fill: #7c3aed;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #6b21a8;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .form-group input[type="text"],
        .form-group input[type="tel"],
        .form-group input[type="date"] {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #f3e8ff;
            border-radius: 14px;
            font-size: 1rem;
            font-family: 'Nunito', sans-serif;
            transition: all 0.3s ease;
            background: #faf5ff;
        }

        .form-group input:focus {
            outline: none;
            border-color: #c084fc;
            background: white;
            box-shadow: 0 0 0 4px rgba(192, 132, 252, 0.2);
        }

        .form-group input::placeholder {
            color: #c4b5fd;
        }

        .villagers-section {
            margin-top: 8px;
        }

        .villager-card {
            background: linear-gradient(135deg, #fdf4ff 0%, #faf5ff 100%);
            border: 2px solid #f3e8ff;
            border-radius: 18px;
            padding: 24px;
            margin-bottom: 16px;
            position: relative;
            transition: all 0.3s ease;
        }

        .villager-card:hover {
            border-color: #e9d5ff;
            box-shadow: 0 8px 30px rgba(168, 85, 247, 0.1);
        }

        .villager-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .villager-number {
            font-weight: 700;
            color: #7c3aed;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .villager-number .badge {
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, #ec4899 0%, #a855f7 100%);
            color: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
        }

        .remove-villager {
            background: none;
            border: none;
            color: #f472b6;
            cursor: pointer;
            padding: 8px;
            border-radius: 10px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            font-family: 'Nunito', sans-serif;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .remove-villager:hover {
            background: #fdf2f8;
            color: #db2777;
        }

        .remove-villager svg {
            width: 18px;
            height: 18px;
        }

        .topics-section {
            margin-top: 16px;
        }

        .topics-label {
            font-weight: 600;
            color: #6b21a8;
            margin-bottom: 12px;
            font-size: 0.95rem;
        }

        .topics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
        }

        .topic-checkbox {
            display: none;
        }

        .topic-label {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            background: white;
            border: 2px solid #f3e8ff;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            color: #7c3aed;
            font-size: 0.9rem;
        }

        .topic-label:hover {
            border-color: #e9d5ff;
            background: #faf5ff;
        }

        .topic-checkbox:checked + .topic-label {
            background: linear-gradient(135deg, #ec4899 0%, #a855f7 100%);
            border-color: transparent;
            color: white;
            box-shadow: 0 4px 15px rgba(168, 85, 247, 0.3);
        }

        .topic-label .check-icon {
            width: 20px;
            height: 20px;
            border: 2px solid #d8b4fe;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .topic-checkbox:checked + .topic-label .check-icon {
            background: white;
            border-color: white;
        }

        .topic-checkbox:checked + .topic-label .check-icon svg {
            opacity: 1;
        }

        .check-icon svg {
            width: 14px;
            height: 14px;
            fill: #a855f7;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .add-villager-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #fdf4ff 0%, #faf5ff 100%);
            border: 2px dashed #d8b4fe;
            border-radius: 16px;
            color: #9333ea;
            font-family: 'Nunito', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .add-villager-btn:hover {
            background: #faf5ff;
            border-color: #c084fc;
            color: #7c3aed;
        }

        .add-villager-btn svg {
            width: 22px;
            height: 22px;
            fill: currentColor;
        }

        .submit-btn {
            width: 100%;
            padding: 18px 32px;
            background: linear-gradient(135deg, #ec4899 0%, #a855f7 100%);
            border: none;
            border-radius: 16px;
            color: white;
            font-family: 'Nunito', sans-serif;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 40px rgba(168, 85, 247, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 50px rgba(168, 85, 247, 0.4);
        }

        .submit-btn:active {
            transform: translateY(0);
        }

        .submit-btn svg {
            width: 22px;
            height: 22px;
            fill: white;
        }

        .info-banner {
            background: linear-gradient(135deg, #fdf4ff 0%, #f5f3ff 100%);
            border-radius: 16px;
            padding: 20px 24px;
            margin-bottom: 24px;
            display: flex;
            align-items: flex-start;
            gap: 16px;
            border: 1px solid #f3e8ff;
        }

        .info-banner .info-icon {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, #f9a8d4 0%, #c4b5fd 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .info-banner .info-icon svg {
            width: 24px;
            height: 24px;
            fill: #7c3aed;
        }

        .info-banner .info-text h3 {
            color: #6b21a8;
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .info-banner .info-text p {
            color: #9333ea;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .footer {
            text-align: center;
            margin-top: 32px;
            color: #9333ea;
            font-size: 0.9rem;
        }

        .footer a {
            color: #7c3aed;
            text-decoration: none;
            font-weight: 600;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .villager-card {
            animation: fadeIn 0.4s ease;
        }

        /* Spinner Animation */
        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        .spinner {
            animation: spin 1s linear infinite;
        }

        /* Results Panel - Always visible */
        .results-panel {
            margin-top: 24px;
            animation: fadeIn 0.4s ease;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .results-header h3 {
            color: #581c87;
            font-size: 1.1rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .results-header .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-badge.success {
            background: #dcfce7;
            color: #166534;
        }

        .status-badge.partial {
            background: #fef3c7;
            color: #92400e;
        }

        .status-badge.error {
            background: #fee2e2;
            color: #991b1b;
        }

        .village-key-display {
            background: linear-gradient(135deg, #fdf4ff 0%, #f5f3ff 100%);
            border: 1px solid #e9d5ff;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 12px;
        }

        .village-key-display .label {
            font-weight: 600;
            color: #6b21a8;
            font-size: 0.9rem;
        }

        .village-key-display .key-value {
            font-family: 'Monaco', 'Consolas', monospace;
            background: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.85rem;
            color: #7c3aed;
            border: 1px solid #e9d5ff;
        }

        .user-result-card {
            background: white;
            border: 1px solid #f3e8ff;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }

        .user-result-card:hover {
            box-shadow: 0 4px 20px rgba(168, 85, 247, 0.1);
        }

        .user-result-card.mother {
            border-left: 4px solid #ec4899;
        }

        .user-result-card.villager {
            border-left: 4px solid #a855f7;
        }

        .user-result-card.error {
            border-left: 4px solid #ef4444;
            background: #fef2f2;
        }

        .user-result-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .user-result-name {
            font-weight: 700;
            color: #581c87;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-result-name .role-badge {
            font-size: 0.7rem;
            padding: 3px 8px;
            border-radius: 6px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .role-badge.mother {
            background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%);
            color: white;
        }

        .role-badge.villager {
            background: linear-gradient(135deg, #a855f7 0%, #c084fc 100%);
            color: white;
        }

        .onesignal-id {
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.75rem;
            color: #9333ea;
            background: #faf5ff;
            padding: 4px 10px;
            border-radius: 6px;
            border: 1px solid #e9d5ff;
        }

        .tags-section {
            margin-top: 12px;
        }

        .tags-section .tags-label {
            font-size: 0.8rem;
            font-weight: 600;
            color: #6b21a8;
            margin-bottom: 8px;
        }

        .tags-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .tag-item {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: #f3e8ff;
            border-radius: 6px;
            font-size: 0.8rem;
        }

        .tag-item .tag-key {
            color: #7c3aed;
            font-weight: 600;
        }

        .tag-item .tag-value {
            color: #581c87;
        }

        .tag-item.true {
            background: #dcfce7;
        }

        .tag-item.true .tag-key {
            color: #166534;
        }

        .tag-item.false {
            background: #fee2e2;
        }

        .tag-item.false .tag-key {
            color: #991b1b;
        }

        .error-message {
            color: #dc2626;
            font-size: 0.85rem;
            margin-top: 8px;
            padding: 8px 12px;
            background: #fef2f2;
            border-radius: 8px;
        }

        .clear-results-btn {
            padding: 10px 20px;
            background: transparent;
            border: 2px solid #e9d5ff;
            border-radius: 10px;
            color: #9333ea;
            font-family: 'Nunito', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .clear-results-btn:hover {
            background: #faf5ff;
            border-color: #c084fc;
        }

        /* API Steps */
        .api-step {
            margin-bottom: 24px;
            padding-bottom: 24px;
            border-bottom: 1px solid #f3e8ff;
        }

        .api-step:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .api-step-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .step-number {
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, #ec4899 0%, #a855f7 100%);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            font-weight: 700;
        }

        .step-title {
            font-weight: 700;
            color: #581c87;
            font-size: 1rem;
            flex: 1;
        }

        .step-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .step-status.success {
            background: #dcfce7;
            color: #166534;
        }

        .step-status.error {
            background: #fee2e2;
            color: #991b1b;
        }

        .step-status.pending {
            background: #fef3c7;
            color: #92400e;
        }

        .api-result-card {
            background: linear-gradient(135deg, #fdf4ff 0%, #faf5ff 100%);
            border: 1px solid #e9d5ff;
            border-radius: 12px;
            padding: 16px;
            margin-top: 12px;
        }

        .api-result-card .result-label {
            font-size: 0.8rem;
            font-weight: 600;
            color: #6b21a8;
            margin-bottom: 8px;
        }

        .api-result-card .result-value {
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.8rem;
            color: #581c87;
            background: white;
            padding: 8px 12px;
            border-radius: 8px;
            word-break: break-all;
        }

        .sms-info, .opt-in-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .sms-info .info-row, .opt-in-info .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: white;
            border-radius: 8px;
        }

        .sms-info .info-label, .opt-in-info .info-label {
            font-weight: 600;
            color: #6b21a8;
            font-size: 0.85rem;
        }

        .sms-info .info-value, .opt-in-info .info-value {
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.8rem;
            color: #7c3aed;
        }

        .opt-in-info .info-value.success {
            color: #16a34a;
        }

        .opt-in-info .info-value.error {
            color: #dc2626;
        }

        /* Reset Button */
        .reset-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            border: none;
            border-radius: 10px;
            color: white;
            font-family: 'Nunito', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .reset-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        .reset-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .reset-btn svg {
            width: 16px;
            height: 16px;
            fill: white;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #9333ea;
        }

        .empty-state .empty-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #f3e8ff 0%, #faf5ff 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
        }

        .empty-state .empty-icon svg {
            width: 28px;
            height: 28px;
            fill: #c4b5fd;
        }

        .empty-state h4 {
            font-size: 1rem;
            font-weight: 700;
            color: #6b21a8;
            margin-bottom: 8px;
        }

        .empty-state p {
            font-size: 0.9rem;
            color: #9333ea;
        }

        /* Loading indicator for steps */
        .step-loading {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 4px 12px;
            background: #fef3c7;
            color: #92400e;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .step-loading .mini-spinner {
            width: 12px;
            height: 12px;
            border: 2px solid #fcd34d;
            border-top-color: #92400e;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        /* Header buttons container */
        .results-header-buttons {
            display: flex;
            gap: 8px;
        }

        /* Due Date Toggle Styles */
        .due-date-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .due-date-toggle {
            display: flex;
            gap: 8px;
        }

        .toggle-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 10px 16px;
            border: 2px solid #f3e8ff;
            border-radius: 10px;
            background: #faf5ff;
            color: #9333ea;
            font-family: 'Nunito', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .toggle-btn:hover {
            border-color: #c084fc;
            background: white;
        }

        .toggle-btn.active {
            background: linear-gradient(135deg, #ec4899 0%, #a855f7 100%);
            border-color: transparent;
            color: white;
        }

        .demo-mode-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 1px solid #fcd34d;
            border-radius: 10px;
            color: #92400e;
            font-size: 0.85rem;
            font-weight: 600;
        }

        /* Mother CTA Section */
        .mother-cta-section {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border: 2px solid #6ee7b7;
            border-radius: 24px;
            padding: 32px;
            margin-bottom: 24px;
            text-align: center;
        }

        .mother-cta-section .cta-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            box-shadow: 0 10px 40px rgba(16, 185, 129, 0.3);
        }

        .mother-cta-section .cta-icon svg {
            width: 45px;
            height: 45px;
            fill: white;
        }

        .mother-cta-section h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #065f46;
            margin-bottom: 12px;
        }

        .mother-cta-section p {
            color: #047857;
            font-size: 1rem;
            margin-bottom: 24px;
            line-height: 1.6;
        }

        .activate-village-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 18px 40px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border: none;
            border-radius: 16px;
            color: white;
            font-family: 'Nunito', sans-serif;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 40px rgba(16, 185, 129, 0.3);
        }

        .activate-village-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 50px rgba(16, 185, 129, 0.4);
        }

        .activate-village-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .activate-village-btn svg {
            width: 24px;
            height: 24px;
            fill: white;
        }

        .mother-info-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: left;
        }

        .mother-info-card .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #d1fae5;
        }

        .mother-info-card .info-row:last-child {
            border-bottom: none;
        }

        .mother-info-card .info-label {
            font-weight: 600;
            color: #065f46;
            font-size: 0.9rem;
        }

        .mother-info-card .info-value {
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.8rem;
            color: #047857;
            background: #ecfdf5;
            padding: 4px 10px;
            border-radius: 6px;
        }

        /* CTA Results */
        .cta-results {
            margin-top: 24px;
            text-align: left;
        }

        .cta-results h4 {
            font-size: 1rem;
            font-weight: 700;
            color: #065f46;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .villager-update-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border-left: 4px solid #10b981;
        }

        .villager-update-card.error {
            border-left-color: #ef4444;
            background: #fef2f2;
        }

        .villager-update-card .villager-name {
            font-weight: 700;
            color: #065f46;
            margin-bottom: 8px;
        }

        .villager-update-card .update-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
        }

        .villager-update-card .update-status.success {
            color: #059669;
        }

        .villager-update-card .update-status.error {
            color: #dc2626;
        }

        /* Responsive */
        @media (max-width: 480px) {
            .card {
                padding: 24px;
            }

            .header h1 {
                font-size: 1.75rem;
            }

            .topics-grid {
                grid-template-columns: 1fr;
            }

            .due-date-toggle {
                flex-direction: column;
            }

            .toggle-btn {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
            </div>
            <h1>Villager Service</h1>
            <p>It takes a village to raise a child</p>
        </header>

        <div class="info-banner" id="signupInfoBanner">
            <div class="info-icon">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                </svg>
            </div>
            <div class="info-text">
                <h3>Build Your Support Network</h3>
                <p>Add the special people in your life who'll be part of your journey. They'll receive helpful updates and ways to support you.</p>
            </div>
        </div>

        <!-- Mother CTA Section - Only visible when onesignal_id is in URL -->
        <div class="mother-cta-section" id="motherCtaSection" style="display: none;">
            <div class="cta-icon">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
            </div>
            <h2>Welcome Back!</h2>
            <p>Your village is ready to support you. Click the button below to activate your support network and notify your villagers.</p>

            <div class="mother-info-card" id="motherInfoCard">
                <div class="info-row">
                    <span class="info-label">Your Mother ID</span>
                    <span class="info-value" id="motherIdDisplay">Loading...</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Villagers Found</span>
                    <span class="info-value" id="villagersFoundDisplay">-</span>
                </div>
            </div>

            <button type="button" class="activate-village-btn" id="activateVillageBtn" onclick="activateVillage()">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
                Activate My Village
            </button>

            <div class="cta-results" id="ctaResults" style="display: none;">
                <h4>
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="#065f46">
                        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                    </svg>
                    Village Activation Results
                </h4>
                <div id="villagerUpdateResults"></div>
            </div>
        </div>

        <form id="villagerForm">
            <div class="card">
                <div class="card-title">
                    <div class="icon">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                        </svg>
                    </div>
                    Your Information
                </div>

                <div class="form-group">
                    <label for="motherName">Your Name</label>
                    <input type="text" id="motherName" name="motherName" placeholder="Enter your full name" required>
                </div>

                <div class="form-group">
                    <label for="dueDate">Expected Due Date</label>
                    <div class="due-date-options">
                        <div class="due-date-toggle">
                            <button type="button" class="toggle-btn active" id="calendarToggle" onclick="setDueDateMode('calendar')">
                                <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                                    <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM9 10H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2zm-8 4H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2z"/>
                                </svg>
                                Calendar
                            </button>
                            <button type="button" class="toggle-btn" id="demoToggle" onclick="setDueDateMode('demo')">
                                <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                                    <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>
                                </svg>
                                Demo (2 min)
                            </button>
                        </div>
                        <input type="date" id="dueDate" name="dueDate" required>
                        <div class="demo-mode-badge" id="demoModeBadge" style="display: none;">
                            <svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor">
                                <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>
                            </svg>
                            Demo Mode: Due date set to 2 minutes from submission
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="motherPhone">Mobile Phone Number</label>
                    <input type="tel" id="motherPhone" name="motherPhone" placeholder="+1 (555) 000-0000" required>
                </div>
            </div>

            <div class="card">
                <div class="card-title">
                    <div class="icon">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/>
                        </svg>
                    </div>
                    Your Villagers
                </div>

                <div class="villagers-section" id="villagersContainer">
                    <!-- Villager cards will be added here -->
                </div>

                <button type="button" class="add-villager-btn" onclick="addVillager()">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                    </svg>
                    Add a Villager
                </button>
            </div>

            <button type="submit" class="submit-btn">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                </svg>
                Complete Sign Up
            </button>
        </form>

        <!-- Results Panel - Always Visible -->
        <div class="results-panel" id="resultsPanel">
            <div class="card">
                <div class="results-header">
                    <h3>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="#7c3aed">
                            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                        </svg>
                        OneSignal API Console
                    </h3>
                    <div class="results-header-buttons">
                        <button class="clear-results-btn" onclick="clearResults()">Clear</button>
                        <button class="reset-btn" id="resetBtn" onclick="resetVillage()" disabled>
                            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                            </svg>
                            Reset (Delete Subscriptions)
                        </button>
                    </div>
                </div>

                <!-- Empty State -->
                <div class="empty-state" id="emptyState">
                    <div class="empty-icon">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                        </svg>
                    </div>
                    <h4>No API Responses Yet</h4>
                    <p>Fill out the form and click "Complete Sign Up" to see API responses here in real-time.</p>
                </div>

                <!-- API Results Container (hidden initially) -->
                <div id="apiResultsWrapper" style="display: none;">
                    <div class="village-key-display">
                        <span class="label">Village Key:</span>
                        <span class="key-value" id="resultVillageKey">-</span>
                    </div>

                    <!-- Step 1: Create Users -->
                    <div class="api-step">
                        <div class="api-step-header">
                            <span class="step-number">1</span>
                            <span class="step-title">Create Users</span>
                            <span id="createUsersStatus"></span>
                        </div>
                        <div id="userResultsContainer">
                            <!-- User result cards will be inserted here in real-time -->
                        </div>
                    </div>

                    <!-- Step 2: Update Mother with Villager IDs -->
                    <div class="api-step" id="motherUpdateStep" style="display: none;">
                        <div class="api-step-header">
                            <span class="step-number">2</span>
                            <span class="step-title">Update Mother with Villager IDs</span>
                            <span id="motherUpdateStatus"></span>
                        </div>
                        <div id="motherUpdateContainer">
                            <!-- Mother update result will be inserted here -->
                        </div>
                    </div>

                    <!-- Step 3: Trigger Villager Opt-In -->
                    <div class="api-step" id="optInStep" style="display: none;">
                        <div class="api-step-header">
                            <span class="step-number">3</span>
                            <span class="step-title">Trigger Villager Opt-In</span>
                            <span id="optInStatus"></span>
                        </div>
                        <div id="optInResultContainer">
                            <!-- Opt-in result will be inserted here -->
                        </div>
                    </div>

                    <!-- Step 4: Reset/Delete Subscriptions (shown after reset) -->
                    <div class="api-step" id="deleteStep" style="display: none;">
                        <div class="api-step-header">
                            <span class="step-number">4</span>
                            <span class="step-title">Delete Subscriptions (Reset)</span>
                            <span id="deleteStatus"></span>
                        </div>
                        <div id="deleteResultsContainer">
                            <!-- Delete results will be inserted here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer class="footer">
            <p>By signing up, you agree to our <a href="#">Terms of Service</a> and <a href="#">Privacy Policy</a></p>
        </footer>
    </div>


    <script>
        // =====================================================
        // OneSignal API Configuration
        // =====================================================
        const ONESIGNAL_CONFIG = {
            appId: 'cf532c5e-5be2-4b00-ab6d-3d3d72ca9124',
            apiUrl: 'https://api.onesignal.com/apps'
        };

        // Store created users for potential deletion
        let createdUsers = [];

        // Due date mode: 'calendar' or 'demo'
        let dueDateMode = 'calendar';

        // Store mother_id from URL (if present) - this is the mother's OneSignal ID
        let motherIdFromUrl = null;

        // Store villager IDs fetched from the mother's profile
        let fetchedVillagerIds = [];

        // =====================================================
        // URL Parsing and Mother CTA Functions
        // =====================================================

        /**
         * Parse the URL to extract mother_id parameter
         * Handles both ? and & as parameter separators
         * @returns {string|null} - The mother_id (OneSignal ID) or null if not found
         */
        function getMotherIdFromUrl() {
            const url = window.location.href;

            // Try standard query parameter format: ?mother_id=xxx or &mother_id=xxx
            const urlParams = new URLSearchParams(window.location.search);
            let motherId = urlParams.get('mother_id');

            if (motherId) {
                return motherId;
            }

            // Handle non-standard format where & is used instead of ?
            // e.g., demo_two.html&abc123 or demo_two.html&mother_id=abc123
            const hashIndex = url.indexOf('#');
            const urlWithoutHash = hashIndex > -1 ? url.substring(0, hashIndex) : url;

            // Check for format: page.html&VALUE (direct value after &)
            const ampMatch = urlWithoutHash.match(/\.html[&?]([a-f0-9-]{36})/i);
            if (ampMatch) {
                return ampMatch[1];
            }

            // Check for format: page.html&mother_id=VALUE
            const paramMatch = urlWithoutHash.match(/[&?]mother_id=([a-f0-9-]+)/i);
            if (paramMatch) {
                return paramMatch[1];
            }

            return null;
        }

        /**
         * View a user in OneSignal by onesignal_id
         * @param {string} onesignalId - The OneSignal ID of the user
         * @returns {Promise<Object>} - User data including tags
         */
        async function viewOneSignalUser(onesignalId) {
            console.log('Viewing OneSignal user:', onesignalId);

            try {
                const response = await fetch(`${ONESIGNAL_CONFIG.apiUrl}/${ONESIGNAL_CONFIG.appId}/users/by/onesignal_id/${onesignalId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (!response.ok) {
                    console.error('OneSignal View User API Error:', result);
                    throw new Error(result.errors?.[0]?.title || 'Failed to view user');
                }

                console.log('OneSignal user data:', result);
                return result;
            } catch (error) {
                console.error('Error viewing OneSignal user:', error);
                throw error;
            }
        }

        /**
         * Extract villager OneSignal IDs from user tags
         * Looks for tags starting with 'villager_' that contain onesignal_ids
         * @param {Object} userData - User data from View User API
         * @returns {Array} - Array of {key, onesignalId} objects
         */
        function extractVillagerIds(userData) {
            const villagerIds = [];
            const tags = userData.properties?.tags || {};

            for (const [key, value] of Object.entries(tags)) {
                // Look for tags like villager_1, villager_2, etc.
                if (key.startsWith('villager_') && value) {
                    // Validate it looks like a onesignal_id (UUID format)
                    if (/^[a-f0-9-]{36}$/i.test(value)) {
                        villagerIds.push({
                            key: key,
                            onesignalId: value
                        });
                    }
                }
            }

            console.log('Extracted villager IDs:', villagerIds);
            return villagerIds;
        }

        /**
         * Activate the village by updating all villagers with activate_villagers: true
         */
        async function activateVillage() {
            if (!motherIdFromUrl) {
                alert('No mother_id found in URL');
                return;
            }

            const activateBtn = document.getElementById('activateVillageBtn');
            const originalBtnText = activateBtn.innerHTML;

            // Show loading state
            activateBtn.innerHTML = `
                <svg class="spinner" viewBox="0 0 24 24" style="animation: spin 1s linear infinite;">
                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" fill="none" stroke-dasharray="31.4 31.4" stroke-linecap="round"/>
                </svg>
                Activating Village...
            `;
            activateBtn.disabled = true;

            try {
                // Step 1: View the mother's user profile to get villager IDs
                console.log('Fetching mother profile to get villager IDs...');
                const motherData = await viewOneSignalUser(motherIdFromUrl);

                // Step 2: Extract villager onesignal_ids from tags
                fetchedVillagerIds = extractVillagerIds(motherData);

                if (fetchedVillagerIds.length === 0) {
                    alert('No villagers found in your profile. Please make sure villagers have been registered.');
                    activateBtn.innerHTML = originalBtnText;
                    activateBtn.disabled = false;
                    return;
                }

                // Update the display
                document.getElementById('villagersFoundDisplay').textContent = fetchedVillagerIds.length;

                // Show results section
                document.getElementById('ctaResults').style.display = 'block';
                document.getElementById('villagerUpdateResults').innerHTML = '';

                // Step 3: Update each villager with activate_villagers: true
                const updateResults = [];

                for (const villager of fetchedVillagerIds) {
                    try {
                        console.log(`Updating villager ${villager.key} (${villager.onesignalId}) with activate_villagers: true`);

                        const updateResult = await updateOneSignalUser(villager.onesignalId, {
                            activate_villagers: 'true'
                        });

                        updateResults.push({
                            key: villager.key,
                            onesignalId: villager.onesignalId,
                            success: true,
                            result: updateResult
                        });

                        // Add success card
                        document.getElementById('villagerUpdateResults').innerHTML += `
                            <div class="villager-update-card">
                                <div class="villager-name">${villager.key}</div>
                                <div class="update-status success">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="#059669">
                                        <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                                    </svg>
                                    Tag "activate_villagers: true" added successfully
                                </div>
                                <div style="font-size: 0.75rem; color: #6b7280; margin-top: 6px;">
                                    ID: ${villager.onesignalId}
                                </div>
                            </div>
                        `;
                    } catch (error) {
                        updateResults.push({
                            key: villager.key,
                            onesignalId: villager.onesignalId,
                            success: false,
                            error: error.message
                        });

                        // Add error card
                        document.getElementById('villagerUpdateResults').innerHTML += `
                            <div class="villager-update-card error">
                                <div class="villager-name">${villager.key}</div>
                                <div class="update-status error">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="#dc2626">
                                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                                    </svg>
                                    Failed: ${error.message}
                                </div>
                                <div style="font-size: 0.75rem; color: #6b7280; margin-top: 6px;">
                                    ID: ${villager.onesignalId}
                                </div>
                            </div>
                        `;
                    }
                }

                const successCount = updateResults.filter(r => r.success).length;
                console.log(`Village activation complete. ${successCount}/${fetchedVillagerIds.length} villagers updated.`);

                // Update button to show completion
                activateBtn.innerHTML = `
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                    </svg>
                    Village Activated! (${successCount}/${fetchedVillagerIds.length})
                `;
                activateBtn.style.background = 'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)';

            } catch (error) {
                console.error('Error activating village:', error);
                alert('Error activating village: ' + error.message);
                activateBtn.innerHTML = originalBtnText;
                activateBtn.disabled = false;
            }
        }

        /**
         * Initialize the mother CTA section if onesignal_id is in URL
         */
        async function initializeMotherCta() {
            motherIdFromUrl = getMotherIdFromUrl();

            if (motherIdFromUrl) {
                console.log('mother_id detected in URL:', motherIdFromUrl);

                // Show the CTA section
                document.getElementById('motherCtaSection').style.display = 'block';
                document.getElementById('motherIdDisplay').textContent = motherIdFromUrl;

                // Hide the signup form and info banner
                document.getElementById('villagerForm').style.display = 'none';
                document.getElementById('signupInfoBanner').style.display = 'none';
                document.getElementById('resultsPanel').style.display = 'none';

                // Try to fetch villager count
                try {
                    const motherData = await viewOneSignalUser(motherIdFromUrl);
                    const villagerIds = extractVillagerIds(motherData);
                    document.getElementById('villagersFoundDisplay').textContent = villagerIds.length;
                    fetchedVillagerIds = villagerIds;
                } catch (error) {
                    console.error('Error fetching mother data:', error);
                    document.getElementById('villagersFoundDisplay').textContent = 'Error loading';
                }
            }
        }

        // =====================================================
        // Due Date Mode Functions
        // =====================================================

        /**
         * Set the due date mode (calendar or demo)
         * @param {string} mode - 'calendar' or 'demo'
         */
        function setDueDateMode(mode) {
            dueDateMode = mode;

            // Update toggle buttons
            document.getElementById('calendarToggle').classList.toggle('active', mode === 'calendar');
            document.getElementById('demoToggle').classList.toggle('active', mode === 'demo');

            // Update date input visibility and demo badge
            const dateInput = document.getElementById('dueDate');
            const demoBadge = document.getElementById('demoModeBadge');

            if (mode === 'demo') {
                dateInput.style.display = 'none';
                dateInput.removeAttribute('required');
                demoBadge.style.display = 'flex';
            } else {
                dateInput.style.display = 'block';
                dateInput.setAttribute('required', 'required');
                demoBadge.style.display = 'none';
            }
        }

        /**
         * Get the due date based on current mode
         * @returns {string} - Date string in YYYY-MM-DD format or timestamp for demo mode
         */
        function getDueDate() {
            if (dueDateMode === 'demo') {
                // Return date 2 minutes from now
                const twoMinutesFromNow = new Date(Date.now() + 2 * 60 * 1000);
                return twoMinutesFromNow.toISOString().split('T')[0];
            }
            return document.getElementById('dueDate').value;
        }

        /**
         * Get the due date as Unix timestamp based on current mode
         * @returns {number} - Unix timestamp in seconds
         */
        function getDueDateTimestamp() {
            if (dueDateMode === 'demo') {
                // Return timestamp 2 minutes from now
                return Math.floor((Date.now() + 2 * 60 * 1000) / 1000);
            }
            return dateToUnixTimestamp(document.getElementById('dueDate').value);
        }

        // =====================================================
        // Utility Functions
        // =====================================================

        /**
         * Generate a unique village_key identifier
         * Format: village_YYYYMMDD_RANDOMHEX
         */
        function generateVillageKey() {
            const date = new Date();
            const dateStr = date.toISOString().slice(0, 10).replace(/-/g, '');
            const randomHex = Math.random().toString(16).substring(2, 10);
            return `village_${dateStr}_${randomHex}`;
        }

        /**
         * Convert a phone number to E.164 format
         * Strips all non-numeric characters except leading +
         * Adds +1 for US numbers if no country code present
         */
        function formatPhoneToE164(phone) {
            // Remove all non-numeric characters except +
            let cleaned = phone.replace(/[^\d+]/g, '');

            // If it doesn't start with +, assume US and add +1
            if (!cleaned.startsWith('+')) {
                // Remove leading 1 if present (to avoid +11...)
                if (cleaned.startsWith('1') && cleaned.length === 11) {
                    cleaned = '+' + cleaned;
                } else {
                    cleaned = '+1' + cleaned;
                }
            }

            return cleaned;
        }

        /**
         * Convert a date string (YYYY-MM-DD) to UNIX timestamp
         */
        function dateToUnixTimestamp(dateString) {
            const date = new Date(dateString);
            return Math.floor(date.getTime() / 1000);
        }

        // =====================================================
        // OneSignal API Functions
        // =====================================================

        /**
         * Create a user in OneSignal with SMS subscription and tags
         * @param {Object} userData - User data object
         * @param {string} userData.phone - Phone number (will be converted to E164)
         * @param {Object} userData.tags - Key-value pairs for user tags
         * @returns {Promise<Object>} - API response (includes identity.onesignal_id)
         */
        async function createOneSignalUser(userData) {
            const e164Phone = formatPhoneToE164(userData.phone);

            const payload = {
                properties: {
                    tags: userData.tags
                },
                subscriptions: [
                    {
                        type: 'SMS',
                        token: e164Phone,
                        enabled: true
                    }
                ]
            };

            console.log('Creating OneSignal user:', {
                phone: e164Phone,
                tags: userData.tags
            });

            try {
                const response = await fetch(`${ONESIGNAL_CONFIG.apiUrl}/${ONESIGNAL_CONFIG.appId}/users`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (!response.ok) {
                    console.error('OneSignal API Error:', result);
                    throw new Error(result.errors?.[0]?.title || 'Failed to create user');
                }

                console.log('OneSignal user created successfully:', result);
                return result;
            } catch (error) {
                console.error('Error creating OneSignal user:', error);
                throw error;
            }
        }

        /**
         * Update a user in OneSignal (add tags to existing user)
         * @param {string} onesignalId - The OneSignal ID of the user to update
         * @param {Object} tags - Key-value pairs of tags to add
         * @returns {Promise<Object>} - API response
         */
        async function updateOneSignalUser(onesignalId, tags) {
            const payload = {
                properties: {
                    tags: tags
                }
            };

            console.log('Updating OneSignal user:', {
                onesignalId: onesignalId,
                tags: tags
            });

            try {
                const response = await fetch(`${ONESIGNAL_CONFIG.apiUrl}/${ONESIGNAL_CONFIG.appId}/users/by/onesignal_id/${onesignalId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (!response.ok) {
                    console.error('OneSignal Update User API Error:', result);
                    throw new Error(result.errors?.[0]?.title || 'Failed to update user');
                }

                console.log('OneSignal user updated successfully:', result);
                return result;
            } catch (error) {
                console.error('Error updating OneSignal user:', error);
                throw error;
            }
        }

        /**
         * Update a user's tags by onesignal_id for villager opt-in
         * This triggers the Journey to send the welcome SMS
         * @param {string} onesignalId - The OneSignal ID from the Create User response
         * @param {string} villagerName - Name of the villager (for logging)
         * @returns {Promise<Object>} - API response
         */
        async function triggerVillagerOptIn(onesignalId, villagerName) {
            const tags = {
                villager_opt_in: 'true'
            };

            console.log('Triggering opt-in for villager:', {
                onesignalId: onesignalId,
                villagerName: villagerName
            });

            return await updateOneSignalUser(onesignalId, tags);
        }

        /**
         * Delete a subscription from OneSignal
         * @param {string} subscriptionId - The subscription ID to delete
         * @returns {Promise<Object>} - API response
         */
        async function deleteSubscription(subscriptionId) {
            console.log('Deleting OneSignal subscription:', subscriptionId);

            try {
                const response = await fetch(`${ONESIGNAL_CONFIG.apiUrl}/${ONESIGNAL_CONFIG.appId}/subscriptions/${subscriptionId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const result = await response.json();
                    console.error('OneSignal Delete Subscription API Error:', result);
                    throw new Error(result.errors?.[0]?.title || 'Failed to delete subscription');
                }

                console.log('OneSignal subscription deleted successfully:', subscriptionId);
                return { success: true, subscriptionId };
            } catch (error) {
                console.error('Error deleting OneSignal subscription:', error);
                throw error;
            }
        }

        // =====================================================
        // Real-time UI Update Functions
        // =====================================================

        /**
         * Show the API results wrapper and hide empty state
         */
        function showApiResults() {
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('apiResultsWrapper').style.display = 'block';
        }

        /**
         * Set loading state for a step
         */
        function setStepLoading(stepId, message = 'Processing...') {
            const statusEl = document.getElementById(stepId);
            if (statusEl) {
                statusEl.innerHTML = `<span class="step-loading"><span class="mini-spinner"></span>${message}</span>`;
            }
        }

        /**
         * Set success state for a step
         */
        function setStepSuccess(stepId, message = 'Success') {
            const statusEl = document.getElementById(stepId);
            if (statusEl) {
                statusEl.innerHTML = `<span class="step-status success">${message}</span>`;
            }
        }

        /**
         * Set error state for a step
         */
        function setStepError(stepId, message = 'Failed') {
            const statusEl = document.getElementById(stepId);
            if (statusEl) {
                statusEl.innerHTML = `<span class="step-status error">${message}</span>`;
            }
        }

        /**
         * Add a user card to the results in real-time
         */
        function addUserCardToResults(userData) {
            const container = document.getElementById('userResultsContainer');
            container.innerHTML += renderUserCard(userData);
        }

        /**
         * Register all village members (mother + villagers) with OneSignal
         * @param {Object} formData - Form data containing mother and villagers info
         * @returns {Promise<Object>} - Results of all API calls
         */
        async function registerVillageWithOneSignal(formData) {
            // Reset created users array
            createdUsers = [];

            // Generate a unique village_key for this village
            const villageKey = generateVillageKey();
            console.log('Generated village_key:', villageKey);

            // Show API results and set village key
            showApiResults();
            document.getElementById('resultVillageKey').textContent = villageKey;
            document.getElementById('userResultsContainer').innerHTML = '';

            // Set Step 1 to loading
            setStepLoading('createUsersStatus', 'Creating users...');

            const results = {
                villageKey: villageKey,
                mother: null,
                villagers: [],
                errors: []
            };

            // 1. Create the mother's user (initial tags - mother_id added after via update)
            let motherOnesignalId = null;
            try {
                const motherData = {
                    phone: formData.mother.phone,
                    tags: {
                        mother_name: formData.mother.name,
                        mother_due_date: formData.mother.dueDateTimestamp,
                        role: 'mother',
                        villager_opt_in: 'true'
                    }
                };

                const motherResponse = await createOneSignalUser(motherData);
                motherOnesignalId = motherResponse.identity?.onesignal_id;

                // Store both the response and the request data for display
                results.mother = {
                    ...motherResponse,
                    requestData: { tags: motherData.tags }
                };

                // Store for potential deletion (using subscription_id)
                const motherSubscriptionId = motherResponse.subscriptions?.[0]?.id;
                if (motherSubscriptionId) {
                    createdUsers.push({
                        subscriptionId: motherSubscriptionId,
                        onesignalId: motherOnesignalId,
                        name: formData.mother.name,
                        role: 'mother'
                    });
                }

                // Update UI in real-time
                addUserCardToResults({
                    role: 'mother',
                    name: formData.mother.name,
                    onesignalId: motherOnesignalId,
                    tags: motherData.tags,
                    success: true
                });

                console.log('Mother registered successfully with onesignal_id:', motherOnesignalId);
            } catch (error) {
                results.errors.push({
                    type: 'mother',
                    error: error.message
                });
                // Update UI with error
                addUserCardToResults({
                    role: 'mother',
                    name: 'Mother',
                    error: error.message,
                    success: false
                });
                console.error('Failed to register mother:', error);
            }

            // 2. Create users for each villager
            for (let i = 0; i < formData.villagers.length; i++) {
                const villager = formData.villagers[i];

                try {
                    // Determine topic values (true/false)
                    const topicMealSupport = villager.topics.includes('meal-support');
                    const topicErrandsHelp = villager.topics.includes('errands');
                    const topicEmotionalSupport = villager.topics.includes('emotional');

                    const villagerData = {
                        phone: villager.phone,
                        tags: {
                            villager_name: villager.name,
                            mother_name: formData.mother.name,
                            topic_meal_support: topicMealSupport.toString(),
                            topic_errands_help: topicErrandsHelp.toString(),
                            topic_emotional_support: topicEmotionalSupport.toString()
                        }
                    };

                    const result = await createOneSignalUser(villagerData);

                    // Extract onesignal_id from the response
                    const onesignalId = result.identity?.onesignal_id;

                    results.villagers.push({
                        name: villager.name,
                        result: result,
                        requestData: { tags: villagerData.tags },
                        onesignalId: onesignalId
                    });

                    // Store for potential deletion (using onesignal_id)
                    if (onesignalId) {
                        createdUsers.push({
                            onesignalId: onesignalId,
                            subscriptionId: result.subscriptions?.[0]?.id,
                            name: villager.name,
                            role: 'villager'
                        });
                    }

                    // Update UI in real-time
                    addUserCardToResults({
                        role: 'villager',
                        name: villagerData.tags.villager_name,
                        onesignalId: result.identity?.onesignal_id,
                        tags: villagerData.tags,
                        success: true
                    });

                    console.log(`Villager ${i + 1} (${villager.name}) registered successfully`);
                } catch (error) {
                    results.errors.push({
                        type: 'villager',
                        index: i,
                        name: villager.name,
                        error: error.message
                    });
                    // Update UI with error
                    addUserCardToResults({
                        role: 'villager',
                        name: villager.name || `Villager ${i + 1}`,
                        error: error.message,
                        success: false
                    });
                    console.error(`Failed to register villager ${i + 1}:`, error);
                }
            }

            // Update Step 1 status
            const userCreateErrors = results.errors.filter(e => e.type === 'mother' || e.type === 'villager');
            if (userCreateErrors.length === 0) {
                setStepSuccess('createUsersStatus', 'Success');
            } else {
                setStepError('createUsersStatus', 'Partial');
            }

            // 3. Update Mother with mother_id and villager onesignal_ids as tags
            if (results.mother && motherOnesignalId) {
                // Show and set Step 2 to loading
                document.getElementById('motherUpdateStep').style.display = 'block';
                setStepLoading('motherUpdateStatus', 'Updating...');

                try {
                    // Build tags object: mother_id + villager onesignal_ids
                    const motherUpdateTags = {
                        mother_id: motherOnesignalId  // Add mother's own OneSignal ID
                    };

                    // Add villager IDs
                    results.villagers.forEach((villager, index) => {
                        const villagerOnesignalId = villager.result?.identity?.onesignal_id;
                        if (villagerOnesignalId) {
                            motherUpdateTags[`villager_${index + 1}`] = villagerOnesignalId;
                        }
                    });

                    console.log('Updating mother with tags:', motherUpdateTags);

                    const updateResult = await updateOneSignalUser(motherOnesignalId, motherUpdateTags);
                    results.motherUpdate = {
                        success: true,
                        result: updateResult,
                        tagsAdded: motherUpdateTags
                    };

                    // Update UI
                    setStepSuccess('motherUpdateStatus', 'Success');
                    const tagsHtml = Object.entries(motherUpdateTags)
                        .map(([key, value]) => `
                            <span class="tag-item">
                                <span class="tag-key">${key}:</span>
                                <span class="tag-value">${value}</span>
                            </span>
                        `).join('');
                    document.getElementById('motherUpdateContainer').innerHTML = `
                        <div class="api-result-card">
                            <div class="result-label">Tags Added to Mother</div>
                            <div class="tags-grid">${tagsHtml}</div>
                        </div>
                    `;

                    console.log('Mother updated with mother_id and villager onesignal_ids');
                } catch (error) {
                    results.errors.push({
                        type: 'mother_update',
                        error: error.message
                    });
                    results.motherUpdate = {
                        success: false,
                        error: error.message
                    };

                    // Update UI with error
                    setStepError('motherUpdateStatus', 'Failed');
                    document.getElementById('motherUpdateContainer').innerHTML = `
                        <div class="error-message"> ${error.message}</div>
                    `;

                    console.error('Failed to update mother with tags:', error);
                }
            }

            // 4. Trigger villager opt-in by updating user tags
            if (results.villagers.length > 0) {
                // Show and set Step 3 to loading
                document.getElementById('optInStep').style.display = 'block';

                // Wait 5 seconds for users to propagate in OneSignal
                console.log('Waiting 5 seconds for users to propagate...');
                for (let i = 5; i > 0; i--) {
                    setStepLoading('optInStatus', `Waiting ${i}s...`);
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
                setStepLoading('optInStatus', 'Triggering...');

                results.optInUpdates = [];
                let optInSuccessCount = 0;

                for (const villager of results.villagers) {
                    if (villager.onesignalId) {
                        try {
                            console.log(`Triggering opt-in for villager: ${villager.name}`);

                            const optInResult = await triggerVillagerOptIn(villager.onesignalId, villager.name);
                            results.optInUpdates.push({
                                name: villager.name,
                                onesignalId: villager.onesignalId,
                                success: true,
                                result: optInResult
                            });
                            optInSuccessCount++;

                        } catch (error) {
                            results.optInUpdates.push({
                                name: villager.name,
                                onesignalId: villager.onesignalId,
                                success: false,
                                error: error.message
                            });
                            results.errors.push({
                                type: 'opt_in_update',
                                villagerName: villager.name,
                                error: error.message
                            });
                            console.error(`Failed to trigger opt-in for villager ${villager.name}:`, error);
                        }
                    }
                }

                // Update UI
                if (optInSuccessCount === results.villagers.length) {
                    setStepSuccess('optInStatus', `${optInSuccessCount} Triggered`);
                } else if (optInSuccessCount > 0) {
                    setStepError('optInStatus', `${optInSuccessCount}/${results.villagers.length} Triggered`);
                } else {
                    setStepError('optInStatus', 'Failed');
                }

                // Build opt-in results HTML
                let optInResultsHtml = '';
                for (const update of results.optInUpdates) {
                    const statusClass = update.success ? 'success' : 'error';
                    const statusIcon = update.success ? '' : '';
                    optInResultsHtml += `
                        <div class="api-result-card">
                            <div class="opt-in-info">
                                <div class="info-row">
                                    <span class="info-label">Villager</span>
                                    <span class="info-value">${update.name}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">OneSignal ID</span>
                                    <span class="info-value" style="font-size: 0.75rem;">${update.onesignalId}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Tag Added</span>
                                    <span class="info-value">villager_opt_in: "true"</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Status</span>
                                    <span class="info-value ${statusClass}">${statusIcon} ${update.success ? 'Journey Triggered' : update.error}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }
                document.getElementById('optInResultContainer').innerHTML = optInResultsHtml;

                console.log('Villager opt-in triggers completed');
            }

            // Enable Reset button if we have created users
            if (createdUsers.length > 0) {
                document.getElementById('resetBtn').disabled = false;
            }

            // Log summary
            console.log('=== Village Registration Summary ===');
            console.log('Village Key:', villageKey);
            console.log('Mother registered:', results.mother ? 'Yes' : 'No');
            console.log('Villagers registered:', results.villagers.length);
            console.log('Mother updated with villager IDs:', results.motherUpdate?.success ? 'Yes' : 'No');
            console.log('Villager opt-ins triggered:', results.optInUpdates?.length || 0);
            console.log('Errors:', results.errors.length);
            console.log('Created users stored for reset:', createdUsers.length);
            console.log('====================================');

            return results;
        }

        // =====================================================
        // UI Functions
        // =====================================================

        let villagerCount = 0;

        function addVillager() {
            villagerCount++;
            const container = document.getElementById('villagersContainer');

            const villagerHtml = `
                <div class="villager-card" id="villager-${villagerCount}">
                    <div class="villager-header">
                        <span class="villager-number">
                            <span class="badge">${villagerCount}</span>
                            Villager ${villagerCount}
                        </span>
                        <button type="button" class="remove-villager" onclick="removeVillager(${villagerCount})">
                            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                            </svg>
                            Remove
                        </button>
                    </div>

                    <div class="form-group">
                        <label for="villagerName-${villagerCount}">Villager's Name</label>
                        <input type="text" id="villagerName-${villagerCount}" name="villagerName-${villagerCount}" placeholder="Enter their name" required>
                    </div>

                    <div class="form-group">
                        <label for="villagerPhone-${villagerCount}">Mobile Phone Number</label>
                        <input type="tel" id="villagerPhone-${villagerCount}" name="villagerPhone-${villagerCount}" placeholder="+1 (555) 000-0000" required>
                    </div>

                    <div class="topics-section">
                        <div class="topics-label">Participating Topics</div>
                        <div class="topics-grid">
                            <div>
                                <input type="checkbox" class="topic-checkbox" id="topic-x-${villagerCount}" name="topics-${villagerCount}" value="meal-support">
                                <label class="topic-label" for="topic-x-${villagerCount}">
                                    <span class="check-icon">
                                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                                        </svg>
                                    </span>
                                    Meal Support
                                </label>
                            </div>
                            <div>
                                <input type="checkbox" class="topic-checkbox" id="topic-y-${villagerCount}" name="topics-${villagerCount}" value="errands">
                                <label class="topic-label" for="topic-y-${villagerCount}">
                                    <span class="check-icon">
                                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                                        </svg>
                                    </span>
                                    Errands Help
                                </label>
                            </div>
                            <div>
                                <input type="checkbox" class="topic-checkbox" id="topic-z-${villagerCount}" name="topics-${villagerCount}" value="emotional">
                                <label class="topic-label" for="topic-z-${villagerCount}">
                                    <span class="check-icon">
                                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                                        </svg>
                                    </span>
                                    Emotional Support
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            container.insertAdjacentHTML('beforeend', villagerHtml);
        }

        function removeVillager(id) {
            const villagerCard = document.getElementById(`villager-${id}`);
            if (villagerCard) {
                villagerCard.style.animation = 'fadeIn 0.3s ease reverse';
                setTimeout(() => {
                    villagerCard.remove();
                    updateVillagerNumbers();
                }, 280);
            }
        }

        function updateVillagerNumbers() {
            const villagerCards = document.querySelectorAll('.villager-card');
            villagerCards.forEach((card, index) => {
                const badge = card.querySelector('.badge');
                const title = card.querySelector('.villager-number');
                if (badge) badge.textContent = index + 1;
                if (title) {
                    title.innerHTML = `<span class="badge">${index + 1}</span> Villager ${index + 1}`;
                }
            });
        }

        // Form submission
        document.getElementById('villagerForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const submitBtn = document.querySelector('.submit-btn');
            const originalBtnText = submitBtn.innerHTML;

            // Collect form data
            const formData = {
                mother: {
                    name: document.getElementById('motherName').value,
                    dueDate: getDueDate(),
                    dueDateTimestamp: getDueDateTimestamp(),
                    phone: document.getElementById('motherPhone').value
                },
                villagers: []
            };

            const villagerCards = document.querySelectorAll('.villager-card');
            villagerCards.forEach((card, index) => {
                const villagerNum = index + 1;
                const nameInput = card.querySelector(`input[id^="villagerName"]`);
                const phoneInput = card.querySelector(`input[id^="villagerPhone"]`);
                const topicCheckboxes = card.querySelectorAll('.topic-checkbox:checked');

                const topics = [];
                topicCheckboxes.forEach(cb => topics.push(cb.value));

                formData.villagers.push({
                    name: nameInput ? nameInput.value : '',
                    phone: phoneInput ? phoneInput.value : '',
                    topics: topics
                });
            });

            console.log('Form submitted:', formData);

            // Show loading state
            submitBtn.innerHTML = `
                <svg class="spinner" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="animation: spin 1s linear infinite;">
                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" fill="none" stroke-dasharray="31.4 31.4" stroke-linecap="round"/>
                </svg>
                Creating Your Village...
            `;
            submitBtn.disabled = true;
            submitBtn.style.opacity = '0.8';

            try {
                // Register all users with OneSignal (UI updates happen in real-time)
                const results = await registerVillageWithOneSignal(formData);

                // Store results for reference
                window.villageRegistrationResults = results;

                // Scroll to results panel
                document.getElementById('resultsPanel').scrollIntoView({ behavior: 'smooth', block: 'start' });
            } catch (error) {
                console.error('Registration failed:', error);
                alert('There was an error creating your village. Please check the console for details.');
            } finally {
                // Restore button state
                submitBtn.innerHTML = originalBtnText;
                submitBtn.disabled = false;
                submitBtn.style.opacity = '1';
            }
        });

        /**
         * Render the results panel with API response data (legacy - kept for reference)
         */
        function renderResultsPanel(results) {
            const panel = document.getElementById('resultsPanel');
            const villageKeyEl = document.getElementById('resultVillageKey');
            const container = document.getElementById('userResultsContainer');

            // Show panel
            panel.classList.add('active');

            // Set village key
            villageKeyEl.textContent = results.villageKey;

            // Clear previous results
            container.innerHTML = '';

            // === Step 1: Create Users ===
            const createUsersStatus = document.getElementById('createUsersStatus');
            const userCreateErrors = results.errors.filter(e => e.type === 'mother' || e.type === 'villager');
            if (userCreateErrors.length === 0) {
                createUsersStatus.textContent = 'Success';
                createUsersStatus.className = 'step-status success';
            } else {
                createUsersStatus.textContent = 'Partial';
                createUsersStatus.className = 'step-status error';
            }

            // Render mother result
            if (results.mother) {
                const motherTags = results.mother.requestData?.tags || {};
                container.innerHTML += renderUserCard({
                    role: 'mother',
                    name: motherTags.name || 'Mother',
                    onesignalId: results.mother.identity?.onesignal_id,
                    tags: motherTags,
                    success: true
                });
            }

            // Check for mother error
            const motherError = results.errors.find(e => e.type === 'mother');
            if (motherError) {
                container.innerHTML += renderUserCard({
                    role: 'mother',
                    name: 'Mother',
                    error: motherError.error,
                    success: false
                });
            }

            // Render villager results
            results.villagers.forEach((villager, index) => {
                const villagerTags = villager.requestData?.tags || {};
                container.innerHTML += renderUserCard({
                    role: 'villager',
                    name: villager.name,
                    onesignalId: villager.result?.identity?.onesignal_id,
                    tags: villagerTags,
                    success: true
                });
            });

            // Check for villager errors
            results.errors
                .filter(e => e.type === 'villager')
                .forEach(error => {
                    container.innerHTML += renderUserCard({
                        role: 'villager',
                        name: error.name || `Villager ${error.index + 1}`,
                        error: error.error,
                        success: false
                    });
                });

            // === Step 2: Update Mother with Villager IDs ===
            const motherUpdateStep = document.getElementById('motherUpdateStep');
            const motherUpdateStatus = document.getElementById('motherUpdateStatus');
            const motherUpdateContainer = document.getElementById('motherUpdateContainer');

            if (results.motherUpdate) {
                motherUpdateStep.style.display = 'block';
                motherUpdateContainer.innerHTML = '';

                if (results.motherUpdate.success) {
                    motherUpdateStatus.textContent = 'Success';
                    motherUpdateStatus.className = 'step-status success';

                    // Show the tags that were added
                    const tagsHtml = Object.entries(results.motherUpdate.tagsAdded || {})
                        .map(([key, value]) => `
                            <span class="tag-item">
                                <span class="tag-key">${key}:</span>
                                <span class="tag-value">${value}</span>
                            </span>
                        `).join('');

                    motherUpdateContainer.innerHTML = `
                        <div class="api-result-card">
                            <div class="result-label">Tags Added to Mother</div>
                            <div class="tags-grid">${tagsHtml}</div>
                        </div>
                    `;
                } else {
                    motherUpdateStatus.textContent = 'Failed';
                    motherUpdateStatus.className = 'step-status error';
                    motherUpdateContainer.innerHTML = `
                        <div class="error-message"> ${results.motherUpdate.error}</div>
                    `;
                }
            }

            // === Step 3: Trigger Villager Opt-In ===
            const optInStep = document.getElementById('optInStep');
            const optInStatus = document.getElementById('optInStatus');
            const optInResultContainer = document.getElementById('optInResultContainer');

            if (results.optInUpdates && results.optInUpdates.length > 0) {
                optInStep.style.display = 'block';
                optInResultContainer.innerHTML = '';

                const successCount = results.optInUpdates.filter(u => u.success).length;
                const totalCount = results.optInUpdates.length;

                if (successCount === totalCount) {
                    optInStatus.textContent = `${successCount} Triggered`;
                    optInStatus.className = 'step-status success';
                } else if (successCount > 0) {
                    optInStatus.textContent = `${successCount}/${totalCount} Triggered`;
                    optInStatus.className = 'step-status error';
                } else {
                    optInStatus.textContent = 'Failed';
                    optInStatus.className = 'step-status error';
                }

                let optInHtml = '';
                for (const update of results.optInUpdates) {
                    const statusClass = update.success ? 'success' : 'error';
                    const statusIcon = update.success ? '' : '';
                    optInHtml += `
                        <div class="api-result-card">
                            <div class="opt-in-info">
                                <div class="info-row">
                                    <span class="info-label">Villager</span>
                                    <span class="info-value">${update.name}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">OneSignal ID</span>
                                    <span class="info-value" style="font-size: 0.75rem;">${update.onesignalId}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Tag Added</span>
                                    <span class="info-value">villager_opt_in: "true"</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Status</span>
                                    <span class="info-value ${statusClass}">${statusIcon} ${update.success ? 'Journey Triggered' : update.error}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }
                optInResultContainer.innerHTML = optInHtml;
            }

            // Scroll to results
            panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        /**
         * Render a single user result card
         */
        function renderUserCard(user) {
            const cardClass = user.success ? user.role : 'error';

            let tagsHtml = '';
            if (user.tags && Object.keys(user.tags).length > 0) {
                const tagItems = Object.entries(user.tags).map(([key, value]) => {
                    // Determine tag styling based on value
                    let tagClass = '';
                    if (value === 'true' || value === true) tagClass = 'true';
                    else if (value === 'false' || value === false) tagClass = 'false';

                    // Format the value for display
                    let displayValue = value;
                    if (typeof value === 'number' && key.includes('date')) {
                        // Convert unix timestamp to readable date
                        displayValue = new Date(value * 1000).toLocaleDateString();
                    }

                    return `<span class="tag-item ${tagClass}">
                        <span class="tag-key">${key}:</span>
                        <span class="tag-value">${displayValue}</span>
                    </span>`;
                }).join('');

                tagsHtml = `
                    <div class="tags-section">
                        <div class="tags-label">Tags</div>
                        <div class="tags-grid">${tagItems}</div>
                    </div>
                `;
            }

            let errorHtml = '';
            if (!user.success && user.error) {
                errorHtml = `<div class="error-message"> ${user.error}</div>`;
            }

            return `
                <div class="user-result-card ${cardClass}">
                    <div class="user-result-header">
                        <div class="user-result-name">
                            ${user.name}
                            <span class="role-badge ${user.role}">${user.role}</span>
                        </div>
                        ${user.onesignalId ? `<span class="onesignal-id">${user.onesignalId}</span>` : ''}
                    </div>
                    ${tagsHtml}
                    ${errorHtml}
                </div>
            `;
        }

        /**
         * Clear the results panel
         */
        function clearResults() {
            document.getElementById('emptyState').style.display = 'block';
            document.getElementById('apiResultsWrapper').style.display = 'none';
            document.getElementById('userResultsContainer').innerHTML = '';
            document.getElementById('motherUpdateContainer').innerHTML = '';
            document.getElementById('optInResultContainer').innerHTML = '';
            document.getElementById('deleteResultsContainer').innerHTML = '';
            document.getElementById('motherUpdateStep').style.display = 'none';
            document.getElementById('optInStep').style.display = 'none';
            document.getElementById('deleteStep').style.display = 'none';
            document.getElementById('resultVillageKey').textContent = '-';
            document.getElementById('createUsersStatus').innerHTML = '';
            document.getElementById('resetBtn').disabled = true;
            createdUsers = [];
        }

        /**
         * Reset the village by deleting all created subscriptions
         */
        async function resetVillage() {
            if (createdUsers.length === 0) {
                alert('No subscriptions to delete.');
                return;
            }

            if (!confirm(`Are you sure you want to delete ${createdUsers.length} subscription(s) from OneSignal?`)) {
                return;
            }

            const resetBtn = document.getElementById('resetBtn');
            resetBtn.disabled = true;
            resetBtn.innerHTML = `
                <svg class="spinner" viewBox="0 0 24 24" style="animation: spin 1s linear infinite;">
                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" fill="none" stroke-dasharray="31.4 31.4" stroke-linecap="round"/>
                </svg>
                Deleting...
            `;

            // Show Step 4: Delete Subscriptions
            document.getElementById('deleteStep').style.display = 'block';
            setStepLoading('deleteStatus', 'Deleting subscriptions...');
            document.getElementById('deleteResultsContainer').innerHTML = '';

            const deleteResults = {
                success: [],
                errors: []
            };

            // Delete each subscription
            for (const user of createdUsers) {
                try {
                    await deleteSubscription(user.subscriptionId);
                    deleteResults.success.push(user);

                    // Add success card
                    document.getElementById('deleteResultsContainer').innerHTML += `
                        <div class="user-result-card villager" style="border-left-color: #22c55e;">
                            <div class="user-result-header">
                                <div class="user-result-name">
                                    ${user.name}
                                    <span class="role-badge ${user.role}">${user.role}</span>
                                </div>
                                <span class="step-status success">Deleted</span>
                            </div>
                            <div style="font-size: 0.8rem; color: #6b21a8; margin-top: 8px;">
                                Subscription ID: <code style="background: #f3e8ff; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem;">${user.subscriptionId}</code>
                            </div>
                        </div>
                    `;
                } catch (error) {
                    deleteResults.errors.push({ user, error: error.message });

                    // Add error card
                    document.getElementById('deleteResultsContainer').innerHTML += `
                        <div class="user-result-card error">
                            <div class="user-result-header">
                                <div class="user-result-name">
                                    ${user.name}
                                    <span class="role-badge ${user.role}">${user.role}</span>
                                </div>
                                <span class="step-status error">Failed</span>
                            </div>
                            <div class="error-message"> ${error.message}</div>
                        </div>
                    `;
                }
            }

            // Update Step 4 status
            if (deleteResults.errors.length === 0) {
                setStepSuccess('deleteStatus', `${deleteResults.success.length} Deleted`);
            } else {
                setStepError('deleteStatus', `${deleteResults.errors.length} Failed`);
            }

            // Reset the button
            resetBtn.innerHTML = `
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                </svg>
                Reset (Delete Subscriptions)
            `;

            // Clear the created users array
            createdUsers = [];

            console.log('=== Village Reset Summary ===');
            console.log('Users deleted:', deleteResults.success.length);
            console.log('Errors:', deleteResults.errors.length);
            console.log('=============================');
        }

        // Set min date to today for due date field
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dueDate').setAttribute('min', today);

            // Check if this is a mother returning via CTA link
            initializeMotherCta();

            // Add first villager automatically (only if signup form is visible)
            if (document.getElementById('villagerForm').style.display !== 'none') {
                addVillager();
            }
        });

    </script>
</body>
</html>
